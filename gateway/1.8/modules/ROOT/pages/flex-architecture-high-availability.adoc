= Flex Gateway Disaster Recovery
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images

Install Flex Gateway in a multi-availability zone mode to ensure live failover. Standard Kubernetes Availability Zone (AZ) distribution policies can be used to distribute Flex Gateway replicas across zones.

Flex Gateway supports the following implementations:

* <<implementation-1>>
* <<implementation-2>>
* <<implementation-3>>

[[implementation-1]]
== Implementation 1: High Availability with the Same APIs in Two Separate Regions

[[implementation-1a]]
=== Implementation 1A: Cross-Regional Flex Gateway

In this implementation a single Flex Gateway has Flex Replicas distributed across multiple region.

In this implementation: 

* The Flex Gateway is registered once in Anypoint Platform and deployed across multiple regions.
* Logs and metrics for each Flex Gateway are consolidated in Anypoint Platform. 
* APIs deployed to the Gateway are available in all regions. 
* API configurations including upstream services and policies are the same for all regions. Upstream services must be region-agnostic meaning either the DNS is local or it lacks any reference to the region.
* The Redis cluster should be replicated across regions. Redis shared storage can also be used.  
* The only cross-regional traffic is Redis synchronization.
* The DNS service is configured for active-active failover to direct traffic to any region at all times.

In the following diagram, Flex Replicas in different regions have distinct Kubernetes deployments:

image:Flex-Gateway-DR-1.png["A detailed view of scenario 1A, which contains the necessary services to support High Availability in different regions Flex Replicas."]


[[implementation-1b]]
=== Implementation 1B: Region-Specific Flex Gateway

In this implementation each region has a distinct Flex Gateway with all resources as independent entities.

In this implementation:

* A separate Flex Gateway is registered for each region.
* There is no cross-regional traffic.
* Shared storage does not require synchronization. 
* API deployments are specific to each Flex Gateway. For each intended API a region supports, you must deploy an API instance to the region's Flex Gateway. 
* Logs and metrics are specific to their region because each Flex Gateway is a distinct entity in Anypoint Platform.
* API Groups can share contracts (access requests) across regions.

In the following diagram, all APIs are duplicated and do not require identical configurations.

image:Flex-Gateway-DR-2.png["A detailed view of scenario 1B, which contains the necessary services to support High Availability in region-specific Flex Gateways."]

[[implementation-2]]
== Implementation 2: Disaster Recovery for APIs

This implementation is similar to <<implementation-1a>>. However, the DNS service is active-passive, so the standby region only receives traffic if the primary region becomes unhealthy. Redis replication is not required because the standby region does not use the same Redis instance.

In the following diagram, Flex Replicas in different regions have distinct Kubernetes deployments:

image:Flex-Gateway-DR-3.png["A detailed view of scenario 2, which contains the necessary services to enable Disaster Recovery for APIs on Flex Gateway."]

[[implementation-3]]
== Implementation 3: Direct Traffic to the Most Convenient Region

In both <<implementation-3a>> and <<implementation-3b>>, Flex Gateway directs traffic to the most convenient region to reduce latency. 

[[implementation-3a]]
=== Implementation 3A: Direct Traffic Using the Same Policies

To have the same API with the same policies served in two regions, use multiple upstreams to direct the traffic to the most convenient region. To learn more about multiple upstreams, see:

* xref:api-manager::create-instance-task-flex.adoc#traffic-management[Multiple Upstream Services for Flex Gateway Running in Connected Mode]
* xref:flex-local-publish-api-multiple-services.adoc[]

This scenario is achieved with an approach similar to the one in scenario 2, adding  routing control layers offered by the service provider to direct traffic to the nearest data center.

[[implementation-3b]]
=== Implementation 3B: Direct Traffic Using Different Policies

The customer wants one API served in two regions using different policies.

To achieve this scenario, deploy region specific gateways and then apply the corresponding distinct policies. 

NOTE: if you want to apply SLA based rate limiting across all regions, then the rate limits must be the same for all regions. Use API groups to consolidate the contracts. 


